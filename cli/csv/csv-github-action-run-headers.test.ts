import { assertEquals } from "dev:asserts"

import { getFakeGithubActionRun } from "../../libs/github/api/action-run/get-fake-github-action-run.ts"
import { getFakeGithubActionWorkflow } from "../../libs/github/api/action-workflows/get-fake-github-action-workflow.ts"

import { arrayToAsyncGenerator, asyncToArray } from "../../utils/utils.ts"

import { githubActionRunAsCsv } from "./csv-github-action-run-headers.ts"

Deno.test("converts action data to a action run CSV row", async () => {
  const args: Parameters<typeof githubActionRunAsCsv> = [arrayToAsyncGenerator([{
    workflow: getFakeGithubActionWorkflow(),
    actionRunData: { run: getFakeGithubActionRun({ referenced_workflows: [] }), duration: 90_000 },
  }])]

  const result = await asyncToArray(githubActionRunAsCsv(...args))

  assertEquals(result, [{
    "Duration (in minutes)": "1.50",
    "actor.avatar_url": "https://avatars.githubusercontent.com/u/98765432?v=4",
    "actor.events_url": "https://api.github.com/users/author-name/events{/privacy}",
    "actor.followers_url": "https://api.github.com/users/author-name/followers",
    "actor.following_url": "https://api.github.com/users/author-name/following{/other_user}",
    "actor.gists_url": "https://api.github.com/users/author-name/gists{/gist_id}",
    "actor.gravatar_id": "",
    "actor.html_url": "https://github.com/author-name",
    "actor.id": "98765432",
    "actor.login": "author-name",
    "actor.node_id": "A_bcDEFgHiJk",
    "actor.organizations_url": "https://api.github.com/users/author-name/orgs",
    "actor.received_events_url": "https://api.github.com/users/author-name/received_events",
    "actor.repos_url": "https://api.github.com/users/author-name/repos",
    "actor.site_admin": "false",
    "actor.starred_url": "https://api.github.com/users/author-name/starred{/owner}{/repo}",
    "actor.subscriptions_url": "https://api.github.com/users/author-name/subscriptions",
    "actor.type": "User",
    "actor.url": "https://api.github.com/users/author-name",
    "artifacts_url": "https://api.github.com/repos/owner/repo/actions/runs/3648870083/artifacts",
    "cancel_url": "https://api.github.com/repos/owner/repo/actions/runs/3648870083/cancel",
    "check_suite_id": "3456789012",
    "check_suite_node_id": "AB_cdEFGHiYwM8AAAACRQvXSA",
    "check_suite_url": "https://api.github.com/repos/owner/repo/check-suites/3456789012",
    "conclusion": "success",
    "created_at": "2022-12-08T13:48:03Z",
    "display_title": "display_titleâ€¦",
    "event": "push",
    "head_branch": "main",
    "head_commit.author.email": "98765432+author-name@users.noreply.github.com",
    "head_commit.author.name": "author-name",
    "head_commit.committer.email": "noreply@github.com",
    "head_commit.committer.name": "GitHub",
    "head_commit.id": "ab1c2d3ef45g6h7ijkl8m90n1op23q4r567st8u9",
    "head_commit.message": "message",
    "head_commit.timestamp": "2022-12-08T13:47:59Z",
    "head_commit.tree_id": "02d8dd5e2c98bc268a1c64014a9f289a8b4a1a99",
    "head_repository.archive_url": "https://api.github.com/repos/owner/repo/{archive_format}{/ref}",
    "head_repository.assignees_url": "https://api.github.com/repos/owner/repo/assignees{/user}",
    "head_repository.blobs_url": "https://api.github.com/repos/owner/repo/git/blobs{/sha}",
    "head_repository.branches_url": "https://api.github.com/repos/owner/repo/branches{/branch}",
    "head_repository.collaborators_url": "https://api.github.com/repos/owner/repo/collaborators{/collaborator}",
    "head_repository.comments_url": "https://api.github.com/repos/owner/repo/comments{/number}",
    "head_repository.commits_url": "https://api.github.com/repos/owner/repo/commits{/sha}",
    "head_repository.compare_url": "https://api.github.com/repos/owner/repo/compare/{base}...{head}",
    "head_repository.contents_url": "https://api.github.com/repos/owner/repo/contents/{+path}",
    "head_repository.contributors_url": "https://api.github.com/repos/owner/repo/contributors",
    "head_repository.deployments_url": "https://api.github.com/repos/owner/repo/deployments",
    "head_repository.description": "description",
    "head_repository.downloads_url": "https://api.github.com/repos/owner/repo/downloads",
    "head_repository.events_url": "https://api.github.com/repos/owner/repo/events",
    "head_repository.fork": "false",
    "head_repository.forks_url": "https://api.github.com/repos/owner/repo/forks",
    "head_repository.full_name": "owner/repo",
    "head_repository.git_commits_url": "https://api.github.com/repos/owner/repo/git/commits{/sha}",
    "head_repository.git_refs_url": "https://api.github.com/repos/owner/repo/git/refs{/sha}",
    "head_repository.git_tags_url": "https://api.github.com/repos/owner/repo/git/tags{/sha}",
    "head_repository.hooks_url": "https://api.github.com/repos/owner/repo/hooks",
    "head_repository.html_url": "https://github.com/owner/repo",
    "head_repository.id": "123456789",
    "head_repository.issue_comment_url": "https://api.github.com/repos/owner/repo/issues/comments{/number}",
    "head_repository.issue_events_url": "https://api.github.com/repos/owner/repo/issues/events{/number}",
    "head_repository.issues_url": "https://api.github.com/repos/owner/repo/issues{/number}",
    "head_repository.keys_url": "https://api.github.com/repos/owner/repo/keys{/key_id}",
    "head_repository.labels_url": "https://api.github.com/repos/owner/repo/labels{/name}",
    "head_repository.languages_url": "https://api.github.com/repos/owner/repo/languages",
    "head_repository.merges_url": "https://api.github.com/repos/owner/repo/merges",
    "head_repository.milestones_url": "https://api.github.com/repos/owner/repo/milestones{/number}",
    "head_repository.name": "repo",
    "head_repository.node_id": "A_bcDEFGhYwA",
    "head_repository.notifications_url":
      "https://api.github.com/repos/owner/repo/notifications{?since,all,participating}",
    "head_repository.owner.avatar_url": "https://avatars.githubusercontent.com/u/1234567?v=4",
    "head_repository.owner.events_url": "https://api.github.com/users/owner/events{/privacy}",
    "head_repository.owner.followers_url": "https://api.github.com/users/owner/followers",
    "head_repository.owner.following_url": "https://api.github.com/users/owner/following{/other_user}",
    "head_repository.owner.gists_url": "https://api.github.com/users/owner/gists{/gist_id}",
    "head_repository.owner.gravatar_id": "",
    "head_repository.owner.html_url": "https://github.com/owner",
    "head_repository.owner.id": "1234567",
    "head_repository.owner.login": "owner",
    "head_repository.owner.node_id": "ABCdEf1kL2MnuPqhdGlvbjQ1MzAxNjQ=",
    "head_repository.owner.organizations_url": "https://api.github.com/users/owner/orgs",
    "head_repository.owner.received_events_url": "https://api.github.com/users/owner/received_events",
    "head_repository.owner.repos_url": "https://api.github.com/users/owner/repos",
    "head_repository.owner.site_admin": "false",
    "head_repository.owner.starred_url": "https://api.github.com/users/owner/starred{/owner}{/repo}",
    "head_repository.owner.subscriptions_url": "https://api.github.com/users/owner/subscriptions",
    "head_repository.owner.type": "Organization",
    "head_repository.owner.url": "https://api.github.com/users/owner",
    "head_repository.private": "true",
    "head_repository.pulls_url": "https://api.github.com/repos/owner/repo/pulls{/number}",
    "head_repository.releases_url": "https://api.github.com/repos/owner/repo/releases{/id}",
    "head_repository.stargazers_url": "https://api.github.com/repos/owner/repo/stargazers",
    "head_repository.statuses_url": "https://api.github.com/repos/owner/repo/statuses/{sha}",
    "head_repository.subscribers_url": "https://api.github.com/repos/owner/repo/subscribers",
    "head_repository.subscription_url": "https://api.github.com/repos/owner/repo/subscription",
    "head_repository.tags_url": "https://api.github.com/repos/owner/repo/tags",
    "head_repository.teams_url": "https://api.github.com/repos/owner/repo/teams",
    "head_repository.trees_url": "https://api.github.com/repos/owner/repo/git/trees{/sha}",
    "head_repository.url": "https://api.github.com/repos/owner/repo",
    "head_sha": "ab1c2d3ef45g6h7ijkl8m90n1op23q4r567st8u9",
    "html_url": "https://github.com/owner/repo/actions/runs/3648870083",
    "id": "3648870083",
    "jobs_url": "https://api.github.com/repos/owner/repo/actions/runs/3648870083/jobs",
    "logs_url": "https://api.github.com/repos/owner/repo/actions/runs/3648870083/logs",
    "name": "Name",
    "node_id": "ABC_deFOGOtYwM7ZfVbD",
    "path": ".github/workflows/name.yml",
    "previous_attempt_url": "null",
    "pull_requests": "",
    "referenced_workflows": ``,
    "repository.archive_url": "https://api.github.com/repos/owner/repo/{archive_format}{/ref}",
    "repository.assignees_url": "https://api.github.com/repos/owner/repo/assignees{/user}",
    "repository.blobs_url": "https://api.github.com/repos/owner/repo/git/blobs{/sha}",
    "repository.branches_url": "https://api.github.com/repos/owner/repo/branches{/branch}",
    "repository.collaborators_url": "https://api.github.com/repos/owner/repo/collaborators{/collaborator}",
    "repository.comments_url": "https://api.github.com/repos/owner/repo/comments{/number}",
    "repository.commits_url": "https://api.github.com/repos/owner/repo/commits{/sha}",
    "repository.compare_url": "https://api.github.com/repos/owner/repo/compare/{base}...{head}",
    "repository.contents_url": "https://api.github.com/repos/owner/repo/contents/{+path}",
    "repository.contributors_url": "https://api.github.com/repos/owner/repo/contributors",
    "repository.deployments_url": "https://api.github.com/repos/owner/repo/deployments",
    "repository.description": "description",
    "repository.downloads_url": "https://api.github.com/repos/owner/repo/downloads",
    "repository.events_url": "https://api.github.com/repos/owner/repo/events",
    "repository.fork": "false",
    "repository.forks_url": "https://api.github.com/repos/owner/repo/forks",
    "repository.full_name": "owner/repo",
    "repository.git_commits_url": "https://api.github.com/repos/owner/repo/git/commits{/sha}",
    "repository.git_refs_url": "https://api.github.com/repos/owner/repo/git/refs{/sha}",
    "repository.git_tags_url": "https://api.github.com/repos/owner/repo/git/tags{/sha}",
    "repository.hooks_url": "https://api.github.com/repos/owner/repo/hooks",
    "repository.html_url": "https://github.com/owner/repo",
    "repository.id": "123456789",
    "repository.issue_comment_url": "https://api.github.com/repos/owner/repo/issues/comments{/number}",
    "repository.issue_events_url": "https://api.github.com/repos/owner/repo/issues/events{/number}",
    "repository.issues_url": "https://api.github.com/repos/owner/repo/issues{/number}",
    "repository.keys_url": "https://api.github.com/repos/owner/repo/keys{/key_id}",
    "repository.labels_url": "https://api.github.com/repos/owner/repo/labels{/name}",
    "repository.languages_url": "https://api.github.com/repos/owner/repo/languages",
    "repository.merges_url": "https://api.github.com/repos/owner/repo/merges",
    "repository.milestones_url": "https://api.github.com/repos/owner/repo/milestones{/number}",
    "repository.name": "repo",
    "repository.node_id": "A_bcDEFGhYwA",
    "repository.notifications_url": "https://api.github.com/repos/owner/repo/notifications{?since,all,participating}",
    "repository.owner.avatar_url": "https://avatars.githubusercontent.com/u/1234567?v=4",
    "repository.owner.events_url": "https://api.github.com/users/owner/events{/privacy}",
    "repository.owner.followers_url": "https://api.github.com/users/owner/followers",
    "repository.owner.following_url": "https://api.github.com/users/owner/following{/other_user}",
    "repository.owner.gists_url": "https://api.github.com/users/owner/gists{/gist_id}",
    "repository.owner.gravatar_id": "",
    "repository.owner.html_url": "https://github.com/owner",
    "repository.owner.id": "1234567",
    "repository.owner.login": "owner",
    "repository.owner.node_id": "ABCdEf1kL2MnuPqhdGlvbjQ1MzAxNjQ=",
    "repository.owner.organizations_url": "https://api.github.com/users/owner/orgs",
    "repository.owner.received_events_url": "https://api.github.com/users/owner/received_events",
    "repository.owner.repos_url": "https://api.github.com/users/owner/repos",
    "repository.owner.site_admin": "false",
    "repository.owner.starred_url": "https://api.github.com/users/owner/starred{/owner}{/repo}",
    "repository.owner.subscriptions_url": "https://api.github.com/users/owner/subscriptions",
    "repository.owner.type": "Organization",
    "repository.owner.url": "https://api.github.com/users/owner",
    "repository.private": "true",
    "repository.pulls_url": "https://api.github.com/repos/owner/repo/pulls{/number}",
    "repository.releases_url": "https://api.github.com/repos/owner/repo/releases{/id}",
    "repository.stargazers_url": "https://api.github.com/repos/owner/repo/stargazers",
    "repository.statuses_url": "https://api.github.com/repos/owner/repo/statuses/{sha}",
    "repository.subscribers_url": "https://api.github.com/repos/owner/repo/subscribers",
    "repository.subscription_url": "https://api.github.com/repos/owner/repo/subscription",
    "repository.tags_url": "https://api.github.com/repos/owner/repo/tags",
    "repository.teams_url": "https://api.github.com/repos/owner/repo/teams",
    "repository.trees_url": "https://api.github.com/repos/owner/repo/git/trees{/sha}",
    "repository.url": "https://api.github.com/repos/owner/repo",
    "rerun_url": "https://api.github.com/repos/owner/repo/actions/runs/3648870083/rerun",
    "run_attempt": "1",
    "run_number": "123",
    "run_started_at": "2022-12-08T13:48:03Z",
    "status": "completed",
    "triggering_actor.avatar_url": "https://avatars.githubusercontent.com/u/98765432?v=4",
    "triggering_actor.events_url": "https://api.github.com/users/author-name/events{/privacy}",
    "triggering_actor.followers_url": "https://api.github.com/users/author-name/followers",
    "triggering_actor.following_url": "https://api.github.com/users/author-name/following{/other_user}",
    "triggering_actor.gists_url": "https://api.github.com/users/author-name/gists{/gist_id}",
    "triggering_actor.gravatar_id": "",
    "triggering_actor.html_url": "https://github.com/author-name",
    "triggering_actor.id": "98765432",
    "triggering_actor.login": "author-name",
    "triggering_actor.node_id": "A_bcDEFgHiJk",
    "triggering_actor.organizations_url": "https://api.github.com/users/author-name/orgs",
    "triggering_actor.received_events_url": "https://api.github.com/users/author-name/received_events",
    "triggering_actor.repos_url": "https://api.github.com/users/author-name/repos",
    "triggering_actor.site_admin": "false",
    "triggering_actor.starred_url": "https://api.github.com/users/author-name/starred{/owner}{/repo}",
    "triggering_actor.subscriptions_url": "https://api.github.com/users/author-name/subscriptions",
    "triggering_actor.type": "User",
    "triggering_actor.url": "https://api.github.com/users/author-name",
    "updated_at": "2022-12-08T14:21:37Z",
    "url": "https://api.github.com/repos/owner/repo/actions/runs/3648870083",
    "workflow_id": "23456789",
    "workflow_url": "https://api.github.com/repos/owner/repo/actions/workflows/23456789",
  }])
})
